<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(NEXUS P2P) - Buy & Sell Crypto</title>
    <style>
        :root { --gold: #f3ba2f; --bg: #0b0e11; --card: #1e2329; --red: #f6465d; --green: #0ecb81; }
        body { font-family: sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
        .container { width: 100%; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; position: relative; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #2b3139; color: #fff; box-sizing: border-box; }
        button { background: var(--gold); color: #000; font-weight: bold; border: none; cursor: pointer; }
        .tab-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: #333; border-radius: 5px; cursor: pointer; font-size: 11px; text-align: center; }
        .active { background: var(--gold); color: #000; }
        .hidden { display: none !important; }
        .eye { position: absolute; right: 15px; top: 22px; color: var(--gold); cursor: pointer; z-index: 10; }
        .status-msg { position: fixed; top: 10px; left: 5%; width: 90%; background: var(--green); color: #000; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; z-index: 5000; display: none; box-shadow: 0 4px 15px #000; }
        .wallet-text { background: #000; padding: 10px; color: var(--gold); font-family: monospace; font-size: 11px; word-break: break-all; border-radius: 5px; border: 1px dashed #555; }
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; display:flex; align-items:center; justify-content:center; }
        .back-btn { background: #444; color: #fff; width: auto; padding: 5px 15px; font-size: 12px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; display: inline-block; }
        .btn-flex { display: flex; gap: 5px; }
        .btn-red { background: var(--red); color: white; }
        .badge { background: #333; color: var(--gold); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; border: 1px solid var(--gold); }
        .dot { height: 10px; width: 10px; background-color: var(--red); border-radius: 50%; display: inline-block; margin-left: 5px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .support-btn { background: #25D366; color: white; margin-top: 10px; text-align: center; text-decoration: none; display: block; padding: 10px; border-radius: 8px; font-size: 12px; }
    </style>
</head>
<body>

<div id="notify" class="status-msg"></div>

<div id="auth-ui" class="container">
    <div id="login-box" class="card">
        <center><h1 style="color:var(--gold);">(NEXUS P2P)</h1></center>
        <center><h2 style="color:var(--gold);">Buy & Sell Crypto</h2><center>
        <input type="email" id="l-email" placeholder="Email">
        <div style="position:relative"><input type="password" id="l-pass" placeholder="Password"><span class="eye" onclick="toggleP('l-pass')">üëÅÔ∏è</span></div>
        <button onclick="auth('login')">LOGIN</button>
        <p onclick="view('forgot')" style="color:var(--gold); cursor:pointer; font-size:12px; text-align:center;">Forgot Password?</p>
        <p onclick="view('signup')" style="color:#ccc; cursor:pointer; font-size:12px; text-align:center;">Register</p>
    </div>

    <div id="signup-box" class="card hidden">
        <h2>Register</h2>
        <select id="s-role"><option value="Buyer">Buyer</option><option value="Seller">Merchant</option></select>
        <input id="s-name" placeholder="Full Name">
        <input id="s-email" placeholder="Email">
        <input id="s-phone" placeholder="Phone Number">
        <input type="password" id="s-pass" placeholder="Password">
        <input id="s-q" placeholder="Security Question">
        <input id="s-a" placeholder="Security Answer">
        <div style="font-size:11px;"><input type="checkbox" id="tos-check" style="width:auto;"> Agree to <a href="#" onclick="showTOS()" style="color:var(--gold);">TOS</a></div>
        <button onclick="auth('signup')">CREATE ACCOUNT</button>
        <p onclick="view('login')" style="text-align:center; cursor:pointer;">Back</p>
    </div>

    <div id="forgot-box" class="card hidden">
        <h2>Recovery</h2>
        <input id="f-email" placeholder="Email">
        <button onclick="recovery('getQ')">FIND ACCOUNT</button>
        <div id="f-area" class="hidden">
            <p id="f-q" style="color:var(--gold);"></p>
            <input id="f-a" placeholder="Answer">
            <button onclick="recovery('checkA')">SHOW PASSWORD</button>
        </div>
        <p onclick="view('login')" style="text-align:center; cursor:pointer;">Back</p>
    </div>
</div>

<div id="main-ui" class="container hidden">
    <div onclick="resetView()" class="back-btn">‚Üê BACK TO HOME</div>
    
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div><b><span id="u-name"></span></b> <small id="u-kyc"></small><span id="notice-dot" class="hidden"><span class="dot"></span></span><br><small id="u-trades" style="color:var(--gold);"></small></div>
        <button onclick="logout()" style="width:auto; padding:5px 10px; background:var(--red); color:#fff; font-size:10px;">LOGOUT</button>
    </div>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="tab(0)">MARKET</div>
        <div id="seller-tab" class="tab-btn hidden" onclick="tab(1)">MERCHANT</div>
        <div class="tab-btn" onclick="tab(2)">PROFILE</div>
        <div class="tab-btn" onclick="tab(3)">HISTORY</div>
    </div>

    <div id="tab0">
        <div id="escrow-card" class="card hidden" style="border:1px solid var(--gold); text-align:center;">
            <small>Account Balance</small><h2 id="live-bal" style="color:var(--gold);"></h2>
        </div>
        <div id="market-list"></div>
    </div>

    <div id="tab1" class="hidden">
        <div class="card">
            <h3>Fund Your Account. Select and copy the wallet address that you wish to fund</h3>
            <select id="e-coin" onchange="updE()"></select>
            <div id="e-addr" class="wallet-text"></div>
            <input type="number" id="e-amt" placeholder="Amount Sent">
            <button onclick="merchDep()">I HAVE DEPOSITED</button>
        </div>
        <div class="card">
            <h3>Withdraw</h3>
            <select id="w-coin-sel"></select>
            <input type="number" id="w-amt" placeholder="Amount">
            <input id="w-wallet" placeholder="External Wallet">
            <button onclick="requestWithdraw()">WITHDRAW</button>
        </div>
        <div class="card">
            <h3>Post Ad</h3>
            <select id="p-coin"></select>
            <input type="number" id="p-qty" placeholder="Quantity">
            <input type="number" id="p-price" placeholder="Price">
            <select id="p-curr"><option value="‚Ç¶">NGN (‚Ç¶)</option><option value="$">USD ($)</option><option value="‚Ç¨">EUR (‚Ç¨)</option></select>
            <button onclick="postAd()">PUBLISH</button>
        </div>
    </div>

    <div id="tab2" class="hidden">
        <div class="card">
            <h3>KYC</h3>
            <input id="k-type" placeholder="ID Type (NIN/Passport)">
            <input id="k-num" placeholder="ID Number">
            <input id="k-phone" placeholder="Phone Number">
            <div id="seller-fields" class="hidden">
                <input id="k-bank" placeholder="Bank Name">
                <input id="k-acc" placeholder="Account Number">
            </div>
            <button onclick="subK()">SUBMIT KYC</button>
        </div>
        <div class="card"><h3>Receiving Wallets</h3><div id="w-list"></div><button onclick="saveW()">SAVE</button></div>
        <a href="https://wa.me/2347030151024" target="_blank" class="support-btn">üí¨ CHAT WITH SUPPORT</a>
    </div>

    <div id="tab3" class="hidden"><div id="hist-list"></div></div>
</div>

<div id="admin-ui" class="container hidden">
    <div class="card" style="text-align:center; border:1px solid var(--gold);">
        <small>Total Commissions</small>
        <h1 id="admin-earned" style="color:var(--gold);">$0.00</h1>
        <button onclick="logout()" style="background:var(--red); color:#fff;">LOGOUT</button>
    </div>
    <div class="card"><h3>Tasks</h3><div id="a-tasks"></div></div>
    <div class="card"><h3>Settings</h3><div id="a-sets"></div><button onclick="addSet()">+ Add</button><button onclick="saveSets()" style="background:var(--green); color:#000;">SAVE</button></div>
</div>

<div id="tos-modal" class="modal hidden"><div class="card" style="width:85%;"><h3>TOS</h3><p>Commissions applies to all trades...</p><button onclick="document.getElementById('tos-modal').classList.add('hidden')">CLOSE</button></div></div>

<div id="buy-modal" class="modal hidden"><div class="card" style="width:90%;">
    <h3 id="bt"></h3>
    <input type="number" id="buy-qty" value="1" oninput="recalcBuy()" placeholder="Quantity">
    <p id="bd"></p>
    <div class="wallet-text" id="admin-bank-details"></div>
    <button onclick="confirmBuy()">I HAVE PAID</button>
    <button onclick="document.getElementById('buy-modal').classList.add('hidden')" style="background:#555;">CANCEL</button>
</div></div>

<div id="edit-modal" class="modal hidden"><div class="card" style="width:90%;">
    <h3>Edit Ad</h3>
    <input type="number" id="edit-qty" placeholder="Quantity">
    <input type="number" id="edit-price" placeholder="Price">
    <button onclick="confirmEdit()">SAVE CHANGES</button>
    <button onclick="document.getElementById('edit-modal').classList.add('hidden')" style="background:#555;">CANCEL</button>
</div></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEDJQILnwL-5GBs6g7UikgR10H305JOSXFKvVsO127HBgoYeSw9QtJJutWr8P7VCDFcA/exec";
    let user, settings, recCache, tBuy, tEditId;

    function notify(m, color="var(--green)"){ const p=document.getElementById('notify'); p.innerText=m; p.style.background=color; p.style.display="block"; setTimeout(()=>p.style.display="none",3000); }
    function view(v){ ['login','signup','forgot'].forEach(id=>document.getElementById(id+'-box').classList.add('hidden')); document.getElementById(v+'-box').classList.remove('hidden'); }
    function toggleP(id){ let i=document.getElementById(id); i.type=i.type==='password'?'text':'password'; }
    function logout(){ localStorage.clear(); location.reload(); }
    function tab(n){ [0,1,2,3].forEach(i=>document.getElementById('tab'+i).classList.toggle('hidden', i!==n)); document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===n)); }
    function showTOS(){ document.getElementById('tos-modal').classList.remove('hidden'); }
    function resetView(){ tab(0); }

    async function auth(act){
        if(act==='signup' && !document.getElementById('tos-check').checked) return notify("Accept TOS!", "var(--red)");
        let p = { action: act, email: (document.getElementById('l-email').value || document.getElementById('s-email').value || "").toLowerCase(), pass: document.getElementById('l-pass').value || document.getElementById('s-pass').value, name: document.getElementById('s-name').value, role: document.getElementById('s-role').value, phone: document.getElementById('s-phone').value, secQ: document.getElementById('s-q').value, secA: document.getElementById('s-a').value };
        const r = await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(p)});
        const d = await r.json();
        if(d.status==='ok') { notify(d.msg); view('login'); }
        else if(d.status==='user'||d.status==='admin'){ localStorage.setItem('p2p_sess', JSON.stringify({email:p.email, pass:p.pass})); location.reload(); }
        else notify(d.msg, "var(--red)");
    }

    async function call(act, extra={}){
        let p = { action: act, email: user.email, ...extra };
        const r = await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(p)});
        const d = await r.json();
        if(d.msg) notify(d.msg);
        if(d.status==='user'){
            user=d.user; settings=d.settings;
            document.getElementById('auth-ui').classList.add('hidden'); document.getElementById('main-ui').classList.remove('hidden');
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-kyc').innerText = "("+user.kyc+")";
            document.getElementById('u-trades').innerText = user.trades + " Trades Completed";
            if(user.notice) document.getElementById('notice-dot').classList.remove('hidden');
            if(user.role === 'Seller'){
                document.getElementById('seller-tab').classList.remove('hidden');
                document.getElementById('escrow-card').classList.remove('hidden');
                document.getElementById('seller-fields').classList.remove('hidden');
                let bObj = JSON.parse(user.balances), bStr = ""; for(let k in bObj) bStr += `${k}:${bObj[k]} `;
                document.getElementById('live-bal').innerText = bStr || "0.00";
            }
            renderMkt(d.allAds); renderW(); renderH(d.history); loadS();
        } else if(d.status==='admin'){
            settings=d.settings; document.getElementById('auth-ui').classList.add('hidden'); document.getElementById('admin-ui').classList.remove('hidden');
            renderAdmin(d);
        }
    }

    function renderMkt(ads){
        let h = ""; ads.forEach((ad, i) => { if(i === 0 || ad[4] !== "ACTIVE") return;
            let btn = "";
            let trades = ad[7] || 0; 
            if(user.role === 'Buyer') {
                btn = `<button onclick="openB('${ad[2]}','${ad[3]}','${ad[6]||'‚Ç¶'}','${ad[1]}')">BUY</button>`;
            } else if(user.role === 'Seller' && ad[1] === user.email) {
                btn = `<div class="btn-flex">
                         <button onclick="openEdit('${ad[0]}','${ad[5]}','${ad[3]}')" style="background:#555; color:#fff;">EDIT</button>
                         <button onclick="deleteAd('${ad[0]}')" class="btn-red">DELETE</button>
                       </div>`;
            }
            h += `<div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${ad[2]}</b> 
                        <span class="badge">‚≠ê ${trades} Trades</span>
                    </div>
                    Price: ${ad[6]||'‚Ç¶'}${ad[3]}<br>
                    <small>Seller: ${ad[1]} | Qty: ${ad[5]}</small><br>
                    ${btn}
                  </div>`; 
        });
        document.getElementById('market-list').innerHTML = h || "No Ads";
    }

    async function deleteAd(id){
        if(confirm("Are you sure you want to delete this ad?")){
            await call('deleteAd', {adId: id});
            location.reload();
        }
    }

    function openEdit(id, q, p){
        tEditId = id;
        document.getElementById('edit-qty').value = q;
        document.getElementById('edit-price').value = p;
        document.getElementById('edit-modal').classList.remove('hidden');
    }
    
    async function confirmEdit(){
        await call('editAd', {adId: tEditId, qty: document.getElementById('edit-qty').value, price: document.getElementById('edit-price').value});
        document.getElementById('edit-modal').classList.add('hidden');
        location.reload();
    }

    function openB(c, p, curr, sEmail){
        tBuy = { c, p, curr, sEmail };
        document.getElementById('bt').innerText = "Buy " + c;
        recalcBuy();
        document.getElementById('admin-bank-details').innerHTML = `Pay Admin:<br>${settings.AdminBankName}<br>Acc: ${settings.AdminAccountNum}<br>Name: ${settings.AdminAccountName}`;
        document.getElementById('buy-modal').classList.remove('hidden');
    }

    function recalcBuy(){
        const q = document.getElementById('buy-qty').value || 1;
        const sub = parseFloat(tBuy.p) * q;
        const fee = (sub * (parseFloat(settings.Commission)/100)).toFixed(2);
        document.getElementById('bd').innerText = "Total: " + tBuy.curr + (sub + parseFloat(fee));
    }

    async function confirmBuy(){
        const w = JSON.parse(user.wallets); if(!w[tBuy.c]) return notify("Set wallet in Account tab!", "var(--red)");
        const q = document.getElementById('buy-qty').value;
        await call('buyRequest', {coin: tBuy.c, amt: parseFloat(tBuy.p)*q, targetWallet: w[tBuy.c], sellerEmail: tBuy.sEmail});
        document.getElementById('buy-modal').classList.add('hidden');
    }

    function renderAdmin(d){
        document.getElementById('admin-earned').innerText = (settings.CurrencySymbol || "$") + d.earnings;
        let s = ""; for(let k in d.settings) s += `<div style="display:flex; gap:5px;"><input class="sk" value="${k}"><input class="sv" value="${d.settings[k]}"></div>`;
        document.getElementById('a-sets').innerHTML = s;
        let t = ""; 
        d.trans.forEach(r => { if(r[5] === 'Pending') {
            t += `<div class="card"><b>${r[4]}: ${r[1]}</b><br>${r[2]} ${r[3]}<br>
                ${r[4]!=='DEPOSIT' ? `Wallet: <span class="wallet-text" id="w-${r[0]}">${r[8]}</span><button onclick="copyW('${r[0]}')">COPY</button>` : ''}
                <button onclick="call('approveAction',{id:'${r[0]}'})">RELEASE</button></div>`;
        }});
        d.users.forEach(u => { if(u[6] === "Awaiting Review") {
            t += `<div class="card"><b>KYC: ${u[4]}</b><br>Phone: ${u[13]}<br>ID Type: ${u[9]}<br>ID Num: ${u[10]}<br><button onclick="call('kycReview',{target:'${u[0]}', status:'Verified'})">APPROVE</button></div>`;
        }});
        document.getElementById('a-tasks').innerHTML = t || "Clear";
    }

    function copyW(id){ navigator.clipboard.writeText(document.getElementById('w-'+id).innerText); notify("Copied!"); }
    function loadS(){
        ['e-coin','p-coin','w-coin-sel'].forEach(id=>{
            const sel=document.getElementById(id); if(!sel) return; sel.innerHTML="";
            for(let k in settings) if(!k.includes('Admin') && k !== 'Commission' && k !== 'CurrencySymbol') sel.innerHTML+=`<option value="${k}">${k}</option>`;
        }); updE();
    }
    function updE(){ 
        const el = document.getElementById('e-coin');
        if(el) document.getElementById('e-addr').innerText = "Copy Address: " + (settings[el.value] || "N/A"); 
    }
    function merchDep(){ call('merchantDeposit', {coin: document.getElementById('e-coin').value, amt: document.getElementById('e-amt').value}); }
    function postAd(){ call('postAd', {coin: document.getElementById('p-coin').value, qty: document.getElementById('p-qty').value, price: document.getElementById('p-price').value, currency: document.getElementById('p-curr').value}); }
    function requestWithdraw(){ call('requestWithdraw', {coin: document.getElementById('w-coin-sel').value, amt: document.getElementById('w-amt').value, wallet: document.getElementById('w-wallet').value}); }
    function subK(){ call('submitKYC', {idType: document.getElementById('k-type').value, idNum: document.getElementById('k-num').value, phone: document.getElementById('k-phone').value, bank: document.getElementById('k-bank').value, acc: document.getElementById('k-acc').value}); }
    function renderW(){
        const s = JSON.parse(user.wallets); let h = ""; for(let k in settings) if(!k.includes('Admin') && k !== 'Commission') h += `${k}: <input class="uw" data-c="${k}" value="${s[k]||''}">`;
        document.getElementById('w-list').innerHTML = h;
    }
    function saveW(){ let w={}; document.querySelectorAll('.uw').forEach(i=>w[i.dataset.c]=i.value); call('saveWallets', {wallets: w}); }
    function addSet(){ let d=document.createElement('div'); d.style.display="flex"; d.innerHTML=`<input class="sk" placeholder="Key"><input class="sv" placeholder="Value">`; document.getElementById('a-sets').appendChild(d); }
    function saveSets(){ let s={}; document.querySelectorAll('.sk').forEach((k,i)=>{ s[k.value]=document.querySelectorAll('.sv')[i].value; }); call('updateSettings',{settings:s}); }
    function renderH(h){ let s=""; h.reverse().forEach(r=>{ s+=`<div class="card" style="font-size:11px;">${r[4]} ${r[2]} ${r[3]} - ${r[5]}</div>` }); document.getElementById('hist-list').innerHTML=s; }
    
    async function recovery(step){
        if(step==='getQ'){
            const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'forgot', email:document.getElementById('f-email').value})});
            const d=await r.json(); if(d.status==='ok'){ recCache=d; document.getElementById('f-q').innerText=d.q; document.getElementById('f-area').classList.remove('hidden'); }
        } else {
            if(document.getElementById('f-a').value.toLowerCase() === recCache.a.toLowerCase()) alert("Password: " + recCache.p);
            else notify("Wrong!", "var(--red)");
        }
    }
    window.onload = () => { const s = localStorage.getItem('p2p_sess'); if(s){ user=JSON.parse(s); call('login',{email:user.email, pass:user.pass}); } };
</script>
</body>
</html>